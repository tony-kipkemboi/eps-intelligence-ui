bundle:
  name: eps-intelligence

variables:
  serving_endpoint_name:
    description: "Name of the model serving endpoint to be used by the app"
    default: "eps_account_agent_v2"
  database_instance_name:
    description: "Base name of the Lakebase database instance"
    default: "eps-intelligence-lakebase"
  resource_name_suffix:
    description: "Suffix for resource names (app/lakebase instance names etc). Helpful for avoiding name collisions if multiple users deploy this app to the same workspace"
    default: "staging"
  source_code_suffix:
    description: "Suffix for source code path to keep environments separate"
    default: "staging-source"
  app_description:
    description: "Description for the Databricks App"
    default: "EPS Account Intelligence Agent - AI-powered account insights"

resources:
  database_instances:
    chatbot_lakebase:
      name: ${var.database_instance_name}-${var.resource_name_suffix}
      capacity: CU_1

  apps:
    databricks_chatbot:
      name: eps-agent-${var.resource_name_suffix}
      description: ${var.app_description}
      source_code_path: /Workspace/Users/${workspace.current_user.userName}/eps-chatbot-${var.source_code_suffix}
      resources:
        - name: serving-endpoint
          description: "Databricks serving endpoint name for the AI agent"
          serving_endpoint:
            name: ${var.serving_endpoint_name}
            permission: CAN_QUERY
        - name: database
          description: "Lakebase database instance for the EPS Intelligence chat app"
          database:
            database_name: databricks_postgres
            instance_name: ${resources.database_instances.chatbot_lakebase.name}
            permission: CAN_CONNECT_AND_CREATE

targets:
  staging:
    mode: production
    default: true
    workspace:
      root_path: /Workspace/Users/tony.kipkemboi@guild.com/.bundle/${bundle.name}/${bundle.target}
    variables:
      serving_endpoint_name: "eps_account_agent_v2"
      database_instance_name: "eps-intelligence-lakebase"
      resource_name_suffix: "staging"
      source_code_suffix: "staging-source"
      app_description: "EPS Account Intelligence Agent - STAGING - AI-powered account insights across Salesforce, Google Drive, Gong, Gmail, and Slack"

  prod:
    mode: production
    workspace:
      root_path: /Workspace/Users/tony.kipkemboi@guild.com/.bundle/${bundle.name}/${bundle.target}
    variables:
      serving_endpoint_name: "eps_account_agent_prod_v2"
      database_instance_name: "eps-intelligence-lakebase"
      resource_name_suffix: "prod"
      source_code_suffix: "prod-source"
      app_description: "EPS Account Intelligence Agent - PRODUCTION - AI-powered account insights across Salesforce, Google Drive, Gong, Gmail, and Slack"
